<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Tasks - Oollert Tasks</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <header>
    <h1>Oollert Tasks</h1>
    <nav>
      <a href="/home">Home</a>
      <form method="POST" action="/logout" style="display:inline">
        <button type="submit">Logout</button>
      </form>
    </nav>
  </header>

  <% if (error && error.length) { %>
    <div style="position: fixed; top: 80px; right: 20px; z-index: 1000;">
      <div class="flash error"><%= error[0] %></div>
    </div>
  <% } %>
  <% if (success && success.length) { %>
    <div style="position: fixed; top: 80px; right: 20px; z-index: 1000;">
      <div class="flash success"><%= success[0] %></div>
    </div>
  <% } %>

  <main class="board">
    <section class="column" data-status="todo">
      <h2>To Do</h2>
      <form method="POST" action="/tasks">
        <input name="title" placeholder="Add new task..." required />
        <button type="submit">+</button>
      </form>
      <div class="cards" id="todo">
        <% tasks.filter(t => t.status === 'todo').forEach(t => { %>
          <div class="card" draggable="true" data-id="<%= t._id %>" data-status="todo">
            <button class="delete-btn" title="Delete task">×</button>
            <h3><%= t.title %></h3>
            <% if (t.description) { %>
              <p><%= t.description %></p>
            <% } %>
            <div class="actions">
              <button class="move" data-target="inprogress">Start →</button>
            </div>
          </div>
        <% }) %>
      </div>
    </section>

    <section class="column" data-status="inprogress">
      <h2>In Progress</h2>
      <div class="cards" id="inprogress">
        <% tasks.filter(t => t.status === 'inprogress').forEach(t => { %>
          <div class="card" draggable="true" data-id="<%= t._id %>" data-status="inprogress">
            <button class="delete-btn" title="Delete task">×</button>
            <h3><%= t.title %></h3>
            <% if (t.description) { %>
              <p><%= t.description %></p>
            <% } %>
            <div class="actions">
              <button class="move" data-target="todo">← Back</button>
              <button class="move" data-target="done">Complete →</button>
            </div>
          </div>
        <% }) %>
      </div>
    </section>

    <section class="column" data-status="done">
      <h2>Done</h2>
      <div class="cards" id="done">
        <% tasks.filter(t => t.status === 'done').forEach(t => { %>
          <div class="card" draggable="true" data-id="<%= t._id %>" data-status="done">
            <button class="delete-btn" title="Delete task">×</button>
            <h3><%= t.title %></h3>
            <% if (t.description) { %>
              <p><%= t.description %></p>
            <% } %>
            <div class="actions">
              <button class="move" data-target="inprogress">← Reopen</button>
            </div>
          </div>
        <% }) %>
      </div>
    </section>
  </main>

  <script>
    // Delete button functionality
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async e => {
        e.stopPropagation(); // Prevent drag from triggering
        
        if (!confirm('Are you sure you want to delete this task?')) {
          return;
        }
        
        const card = e.target.closest('.card');
        const id = card.dataset.id;
        
        // Visual feedback
        card.style.transition = 'all 0.3s';
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8) rotate(-5deg)';
        
        try {
          const res = await fetch(`/tasks/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (res.ok) {
            setTimeout(() => card.remove(), 300);
          } else {
            // Restore card if delete failed
            card.style.opacity = '1';
            card.style.transform = 'scale(1) rotate(0deg)';
            alert('Failed to delete task. Please try again.');
          }
        } catch (err) {
          console.error('Failed to delete task:', err);
          card.style.opacity = '1';
          card.style.transform = 'scale(1) rotate(0deg)';
          alert('Network error. Please check your connection.');
        }
      });
    });

    // Move button functionality (fallback for non-drag users)
    document.querySelectorAll('.move').forEach(btn => {
      btn.addEventListener('click', async e => {
        const card = e.target.closest('.card');
        const id = card.dataset.id;
        const status = e.target.dataset.target;
        
        card.classList.add('loading');
        
        try {
          const res = await fetch(`/tasks/${id}/move`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
          });
          
          if (res.ok) {
            // Smooth transition
            card.style.transition = 'all 0.3s';
            card.style.opacity = '0';
            card.style.transform = 'scale(0.8)';
            setTimeout(() => location.reload(), 300);
          }
        } catch (err) {
          console.error('Failed to move task:', err);
          card.classList.remove('loading');
        }
      });
    });

    // Drag and Drop Implementation
    let draggedCard = null;
    let sourceColumn = null;

    // Get all cards and add drag event listeners
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
    });

    // Get all columns and add drop event listeners
    document.querySelectorAll('.cards').forEach(column => {
      column.addEventListener('dragover', handleDragOver);
      column.addEventListener('drop', handleDrop);
      column.addEventListener('dragleave', handleDragLeave);
      column.addEventListener('dragenter', handleDragEnter);
    });

    function handleDragStart(e) {
      draggedCard = this;
      sourceColumn = this.closest('.column').dataset.status;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      
      // Remove drag-over class from all columns
      document.querySelectorAll('.column').forEach(col => {
        col.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      this.closest('.column').classList.add('drag-over');
    }

    function handleDragLeave(e) {
      // Only remove if we're actually leaving the column
      if (e.target.classList.contains('cards')) {
        this.closest('.column').classList.remove('drag-over');
      }
    }

    async function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      const targetColumn = this.closest('.column').dataset.status;
      this.closest('.column').classList.remove('drag-over');
      
      if (draggedCard && sourceColumn !== targetColumn) {
        const cardId = draggedCard.dataset.id;
        
        // Visual feedback
        draggedCard.classList.add('loading');
        
        try {
          const res = await fetch(`/tasks/${cardId}/move`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: targetColumn })
          });
          
          if (res.ok) {
            // Smooth transition effect
            draggedCard.style.transition = 'all 0.3s';
            draggedCard.style.opacity = '0';
            draggedCard.style.transform = 'translateX(20px)';
            
            setTimeout(() => {
              // Move the card to new column
              this.appendChild(draggedCard);
              draggedCard.dataset.status = targetColumn;
              
              // Reset styles
              draggedCard.style.opacity = '1';
              draggedCard.style.transform = 'translateX(0)';
              draggedCard.classList.remove('loading');
              
              // Update the action buttons based on new status
              updateActionButtons(draggedCard, targetColumn);
            }, 300);
          } else {
            draggedCard.classList.remove('loading');
            alert('Failed to move task. Please try again.');
          }
        } catch (err) {
          console.error('Error moving task:', err);
          draggedCard.classList.remove('loading');
          alert('Network error. Please check your connection.');
        }
      }
      
      return false;
    }

    function updateActionButtons(card, status) {
      const actionsDiv = card.querySelector('.actions');
      actionsDiv.innerHTML = '';
      
      // Add delete button if it doesn't exist
      if (!card.querySelector('.delete-btn')) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.title = 'Delete task';
        deleteBtn.textContent = '×';
        deleteBtn.addEventListener('click', async e => {
          e.stopPropagation();
          
          if (!confirm('Are you sure you want to delete this task?')) {
            return;
          }
          
          const cardId = card.dataset.id;
          card.style.transition = 'all 0.3s';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.8) rotate(-5deg)';
          
          try {
            const res = await fetch(`/tasks/${cardId}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (res.ok) {
              setTimeout(() => card.remove(), 300);
            } else {
              card.style.opacity = '1';
              card.style.transform = 'scale(1) rotate(0deg)';
              alert('Failed to delete task. Please try again.');
            }
          } catch (err) {
            console.error('Failed to delete task:', err);
            card.style.opacity = '1';
            card.style.transform = 'scale(1) rotate(0deg)';
            alert('Network error. Please check your connection.');
          }
        });
        card.insertBefore(deleteBtn, card.firstChild);
      }
      
      if (status === 'todo') {
        actionsDiv.innerHTML = '<button class="move" data-target="inprogress">Start →</button>';
      } else if (status === 'inprogress') {
        actionsDiv.innerHTML = '<button class="move" data-target="todo">← Back</button><button class="move" data-target="done">Complete →</button>';
      } else if (status === 'done') {
        actionsDiv.innerHTML = '<button class="move" data-target="inprogress">← Reopen</button>';
      }
      
      // Re-attach click listeners to new buttons
      actionsDiv.querySelectorAll('.move').forEach(btn => {
        btn.addEventListener('click', async e => {
          const card = e.target.closest('.card');
          const id = card.dataset.id;
          const status = e.target.dataset.target;
          
          card.classList.add('loading');
          
          try {
            const res = await fetch(`/tasks/${id}/move`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status })
            });
            
            if (res.ok) {
              card.style.transition = 'all 0.3s';
              card.style.opacity = '0';
              card.style.transform = 'scale(0.8)';
              setTimeout(() => location.reload(), 300);
            }
          } catch (err) {
            console.error('Failed to move task:', err);
            card.classList.remove('loading');
          }
        });
      });
    }

    // Auto-hide flash messages after 5 seconds
    setTimeout(() => {
      document.querySelectorAll('.flash').forEach(flash => {
        flash.style.transition = 'opacity 0.5s';
        flash.style.opacity = '0';
        setTimeout(() => flash.remove(), 500);
      });
    }, 5000);
  </script>
</body>
</html>